<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>My test page</title>
    
    <link rel="manifest" href="manifest.json">	
    <link href="static/img/dog.jpg" rel="shortcut icon">
  </head>
  <style>
      .enable-notifications{
          display: none;
      }
  </style>
<script>
    // 支援serviceWorker才存入sw.js檔
    if('serviceWorker' in navigator) {
      
      // window load後才執行，以免增加頁面讀取的時間
      window.addEventListener('load', function() {
        
        // 建立sw.js
        navigator.serviceWorker.register('https://hosp-nckm.github.io/web/notify/sw.js')
          .then(function(reg) {
            console.log(reg.scope); // 看這支sw.js執行的範圍
          })
          // 註冊失敗
          .catch(function(err) {
            console.log('error: ', err);
          });
       
        // 附上刪除sw.js的寫法
        navigator.serviceWorker.getRegistrations().then(function(reg) {
          for(var reg of reg) {
            reg.unregister()
          }
        });
        
      });
    }
  </script>
  <body>
      <button class="enable-notifications">按我</button>
    <!--img src="images/firefox-icon.png" alt="My test image"-->
  </body>
  <script>
    /*alert('Notification' in window);*/
    var enableNotifications = document.querySelectorAll('.enable-notifications');
    console.log(enableNotifications.length);
    if ('Notification' in window) {
      /*console.log(enableNotifications[i].style.display);*/
  for (var i= 0; i < enableNotifications.length; i++) {
      console.log(enableNotifications[i].style.display);
      enableNotifications[i].style.display = 'inline-block';
      enableNotifications[i].addEventListener('click', askForNotificationPermission);
  }
}
/*function displayNotification(){
   new Notification('訂閱成功！！！');
}*/

function askForNotificationPermission() {
    Notification.requestPermission(function(status){
        console.log('User Choice', status);
        if (status !== 'granted') {
            console.log('推播允許被拒絕了!');
        } else {
            setPushSubscribe();//displayNotification();
        }
    });
}
function displayNotification(){
    if('serviceWorker' in navigator){
        var options = {
            body: '歡迎進入30天PWA的世界'           
        };
        navigator.serviceWorker.ready
            .then(function(sw){
                sw.showNotification('訂閱成功！！！', options);
            })
    }  
     
}
    
//從伺服器發出訊息不管使用者是不是正在瀏覽網站
function setPushSubscribe(){
  if (!('serviceWorker' in navigator)) 
        return;
    
    navigator.serviceWorker.ready
        .then(function(sw){
          return sw.pushManager.getSubscription();
        })
        .then(function(sub){
            if(sub === null){
                //建立新的訂閱
                /*reg.pushManager.subscribe({
                    userVisibleOnly: true
                });*/
                
                  //建立新的訂閱
                  var vapidPKey = 'BIXV6a4fs-lgvVTZ3o-1UZOL2S9Fes8-pujFvLIZLjE-uR71MrE2W2YMcz-0DzYj4FMbCWwnQ3hZjgZf-9plzKc';
                      var convertedVapidPKey = urlBase64ToUint8Array(vapidPKey);
                      return sub.pushManager.subscribe({
                          userVisibleOnly: true,
                          applicationServerKey: convertedVapidPKey
                      }).then(function(newSub){
                      return fetch('https://notify-95b9f.firebaseio.com/subscriptions.json', {
                          method: 'POST',
                          headers: {
                              'Content-TYpe': 'application/json',
                              'Accept': 'application/json'
                          },
                          body: JSON.stringify(newSub)
                      }).then(function(response){
                          if(response.ok)
                              displayNotification();
                      })
                      .catch(function(err){
                          console.log('訂閱失敗',err);
                      });
                  });
                  
            }else{
                //已經訂閱
            }
        });
}


function urlBase64ToUint8Array(base64String){
    var padding = '='.repeat((4 - base64String.length % 4) % 4);
    var base64 = (base64String + padding)
        .replace(/\-/g, '+')
        .replace(/_/g,'/');
    var rawData = window.atob(base64);
    var outputArr = new Uint8Array(rawData.length);

    for (var i = 0; i < rawData.length; ++i ){
        outputArr[i] = rawData.charCodeAt(i);
    }    
    return outputArr;
}
</script>
</html>
